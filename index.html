<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cartola Stats App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-screen-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cartola Stats">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <style>
        :root {
            --primary: #2ecc71;
            --secondary: #27ae60;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #666;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text-main);
            padding-bottom: 40px; /* Espaço extra no final */
        }

        /* Loading State Moderno */
        #loading-container {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ddd;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* App Header */
        header {
            background: #000;
            color: #fff;
            padding: 20px;
            text-align: center;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .container {
            max-width: 600px; /* Largura ideal para celular */
            margin: 0 auto;
            padding: 0 16px;
        }

        .hidden { display: none !important; }

        /* Estilização de Inputs Estilo App */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
            padding-left: 4px;
        }

        select {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            background-color: var(--card-bg);
            font-size: 1rem;
            font-family: inherit;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            box-shadow: var(--shadow);
        }

        /* Cards do Dashboard */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card h3 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            color: #333;
        }

        h2 {
            font-size: 1.1rem;
            margin: 30px 0 15px 0;
            padding-left: 4px;
            border-left: 4px solid var(--primary);
            line-height: 1;
        }

        /* Tabela Modernizada */
        .table-container {
            overflow: hidden;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        th {
            background: #f8f9fa;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        td {
            padding: 14px;
            text-align: center;
            font-size: 0.95rem;
            border-bottom: 1px solid #f1f1f1;
        }

        tr:last-child td { border-bottom: none; }

        /* Grid de Gráficos */
        .chart-grid {
            display: grid;
            gap: 16px;
        }

        canvas {
            max-width: 100% !important;
        }

        /* Ajustes de Cor por Dataset */
        .title-pts { color: #27ae60; }
        .title-val { color: #c0392b; }

    </style>
</head>

<body>
    <div id="loading-container">
        <div class="spinner"></div>
        <p style="font-weight: 600;">Carregando Arena...</p>
        <p style="color: #888; font-size: 0.8rem;">Sincronizando com a API do Cartola</p>
    </div>

    <header>
        <h1>Cartola Stats Dash</h1>
    </header>

    <div class="container hidden" id="main-container">
        
        <div class="input-group">
            <label>PERFIL DO JOGADOR</label>
            <select id="playerSelect">
                <option value="GEORGE">GEORGE</option>
                <option value="LEO">LEO</option>
                <option value="PAULO">PAULO</option>
                <option value="RAFAEL">RAFAEL</option>
                <option value="VITOR">VITOR</option>
                <option value="XINGU">XINGU</option>
            </select>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Rodada</th>
                        <th>Pontuação</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="input-group">
            <label>ANÁLISE POR RODADA</label>
            <select id="rodadaSelect"></select>
        </div>

        <div class="chart-grid">
            <div class="card">
                <h3 class="title-pts">Pontuação Rodada</h3>
                <canvas id="filtroChart"></canvas>
            </div>
            <div class="card">
                <h3 class="title-val">Valorização Rodada</h3>
                <canvas id="valorizacaoChart"></canvas>
            </div>
        </div>

        <h2>Desempenho Geral</h2>
        <div class="chart-grid">
            <div class="card">
                <h3>Vitórias na Rodada</h3>
                <canvas id="vitoriasChart"></canvas>
            </div>
            <div class="card">
                <h3>2º Lugares</h3>
                <canvas id="segundosChart"></canvas>
            </div>
            <div class="card">
                <h3>Lanternas</h3>
                <canvas id="lanternasChart"></canvas>
            </div>
        </div>

        <h2>Classificação Mensal</h2>
        <div class="card">
            <div class="input-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>RODADAS</label>
                    <select id="rodadasMensaisSelect"></select>
                </div>
                <div style="flex: 1;">
                    <label>MÊS</label>
                    <select id="mesSelect">
                        <option value="Janeiro">Janeiro</option>
                        <option value="Fevereiro">Fevereiro</option>
                        <option value="Março">Março</option>
                        <option value="Abril">Abril</option>
                        <option value="Maio">Maio</option>
                        <option value="Junho">Junho</option>
                        <option value="Julho">Julho</option>
                        <option value="Agosto">Agosto</option>
                        <option value="Setembro">Setembro</option>
                        <option value="Outubro">Outubro</option>
                        <option value="Novembro">Novembro</option>
                        <option value="Dezembro">Dezembro</option>
                    </select>
                </div>
            </div>
            <canvas id="classificacaoMensalChart"></canvas>
        </div>

        <h2>Evolução Patrimonial</h2>
        <div class="card">
            <h3>Total de Pontos (Acumulado)</h3>
            <canvas id="cumulativeScoreChart"></canvas>
        </div>
        <div class="card">
            <h3>Evolução de Cartoletas</h3>
            <canvas id="cumulativeCartoletasChart"></canvas>
        </div>
    </div>

    <script>
        // --- TODA A LÓGICA ORIGINAL FOI PRESERVADA ---
        const timeIDs = {
            'GEORGE': 26323967, 'XINGU': 26331075, 'LEO': 20129034,
            'PAULO': 27110420, 'VITOR': 5214103, 'RAFAEL': 22004383
        };
        const players = Object.keys(timeIDs);

        async function iniciarAplicacao() {
            const loadingContainer = document.getElementById('loading-container');
            const mainContainer = document.getElementById('main-container');
            const proxyUrl = 'https://corsproxy.io/?';

            try {
                const statusResponse = await fetch(`${proxyUrl}https://api.cartola.globo.com/mercado/status`);
                const mercadoStatus = await statusResponse.json();
                const ultimaRodadaFechada = mercadoStatus.rodada_atual - 1;

                if (ultimaRodadaFechada <= 0) {
                     loadingContainer.innerHTML = '<p>Mercado Aberto. Aguardando R01.</p>';
                     return;
                }

                const dadosPontuacao = {};
                const dadosValorizacao = {};
                const patrimonioAnterior = {};
                players.forEach(p => { dadosPontuacao[p] = []; dadosValorizacao[p] = []; patrimonioAnterior[p] = 100.00; });

                for (let r = 1; r <= ultimaRodadaFechada; r++) {
                    for (const p of players) {
                        try {
                            const resp = await fetch(`${proxyUrl}https://api.cartola.globo.com/time/id/${timeIDs[p]}/${r}`);
                            const data = await resp.json();
                            dadosPontuacao[p].push(data.pontos || 0);
                            const pat = data.patrimonio || patrimonioAnterior[p];
                            dadosValorizacao[p].push(pat - patrimonioAnterior[p]);
                            patrimonioAnterior[p] = pat;
                        } catch (e) { dadosPontuacao[p].push(0); dadosValorizacao[p].push(0); }
                    }
                }

                renderizarPaginaCompleta(dadosPontuacao, dadosValorizacao, ultimaRodadaFechada);
                loadingContainer.classList.add('hidden');
                mainContainer.classList.remove('hidden');
            } catch (e) { loadingContainer.innerHTML = '<p>Erro de Conexão.</p>'; }
        }

        function renderizarPaginaCompleta(data, valorizacao, totalRodadas) {
            Chart.register(ChartDataLabels);
            const rodadas = Array.from({ length: totalRodadas }, (_, i) => i + 1);

            const rodadaSelect = document.getElementById('rodadaSelect');
            const rodadasMensaisSelect = document.getElementById('rodadasMensaisSelect');
            rodadas.forEach(r => {
                rodadaSelect.innerHTML += `<option value="${r}">Rodada ${r}</option>`;
                rodadasMensaisSelect.innerHTML += `<option value="${r}">${r} Rodadas</option>`;
            });
            rodadaSelect.value = totalRodadas;
            rodadasMensaisSelect.value = totalRodadas;

            let charts = {};

            function getBarChartConfig(label, dataValues, color, isInteger = false) {
                return {
                    type: 'bar',
                    data: {
                        labels: dataValues.map(e => e.player),
                        datasets: [{ data: dataValues.map(e => e.value), backgroundColor: color, borderRadius: 8 }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end', align: 'right',
                                formatter: (v) => isInteger ? v : v.toFixed(1),
                                color: '#444', font: { weight: 'bold', size: 11 }
                            }
                        },
                        scales: {
                            x: { display: false, beginAtZero: true },
                            y: { grid: { display: false }, ticks: { color: '#333', font: { weight: '600' } } }
                        }
                    }
                };
            }

            function createChart(key, ctxId, config) {
                if (charts[key]) charts[key].destroy();
                charts[key] = new Chart(document.getElementById(ctxId).getContext('2d'), config);
            }

            function updateRodadaCharts() {
                const r = parseInt(rodadaSelect.value) - 1;
                const pts = players.map(p => ({ player: p, value: data[p][r] || 0 })).sort((a,b) => b.value - a.value);
                const val = players.map(p => ({ player: p, value: valorizacao[p][r] || 0 })).sort((a,b) => b.value - a.value);
                createChart('filtro', 'filtroChart', getBarChartConfig('', pts, '#2ecc71'));
                createChart('valor', 'valorizacaoChart', getBarChartConfig('', val, '#e74c3c'));
            }

            function updateVitoriasLanternas() {
                const vit = players.map(() => 0), seg = players.map(() => 0), lan = players.map(() => 0);
                for (let i = 0; i < rodadas.length; i++) {
                    const rV = players.map((p, idx) => ({ idx, v: data[p][i] })).filter(x => x.v !== undefined).sort((a,b) => b.v - a.v);
                    if (rV.length > 0) {
                        const max = rV[0].v, min = rV[rV.length-1].v;
                        rV.forEach(x => { if(x.v === max) vit[x.idx]++; if(x.v === min) lan[x.idx]++; });
                        const sM = rV.find(x => x.v < max)?.v;
                        if (sM !== undefined) rV.forEach(x => { if(x.v === sM) seg[x.idx]++; });
                    }
                }
                const dV = players.map((p, i) => ({ player: p, value: vit[i] })).sort((a,b) => b.value - a.value);
                const dS = players.map((p, i) => ({ player: p, value: seg[i] })).sort((a,b) => b.value - a.value);
                const dL = players.map((p, i) => ({ player: p, value: lan[i] })).sort((a,b) => b.value - a.value);
                createChart('vit', 'vitoriasChart', getBarChartConfig('', dV, '#2ecc71', true));
                createChart('seg', 'segundosChart', getBarChartConfig('', dS, '#3498db', true));
                createChart('lan', 'lanternasChart', getBarChartConfig('', dL, '#e74c3c', true));
            }

            function updateClassificacaoMensal() {
                const n = parseInt(rodadasMensaisSelect.value);
                const res = players.map(p => {
                    let t = 0, start = Math.max(0, rodadas.length - n);
                    for (let i = start; i < rodadas.length; i++) t += (data[p][i] || 0);
                    return { player: p, value: t };
                }).sort((a,b) => b.value - a.value);
                createChart('mes', 'classificacaoMensalChart', getBarChartConfig('', res, '#9b59b6'));
            }

            function createCumulative() {
                const c = { GEORGE: '#2ecc71', XINGU: '#e74c3c', LEO: '#2c3e50', PAULO: '#d35400', VITOR: '#3498db', RAFAEL: '#f1c40f' };
                const opt = { 
                    responsive: true, 
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }, datalabels: { display: false } },
                    scales: { y: { grid: { color: '#eee' } }, x: { grid: { display: false } } }
                };
                const sD = players.map(p => { let s = 0; return { label: p, data: data[p].map(v => s += (v || 0)), borderColor: c[p], tension: 0.3, pointRadius: 2 }; });
                createChart('cumPts', 'cumulativeScoreChart', { type: 'line', data: { labels: rodadas.map(r => `R${r}`), datasets: sD }, options: opt });
                const cD = players.map(p => { let t = 100; return { label: p, data: [100, ...valorizacao[p].map(v => t += (v || 0))], borderColor: c[p], tension: 0.3, pointRadius: 2 }; });
                createChart('cumCart', 'cumulativeCartoletasChart', { type: 'line', data: { labels: ['In.', ...rodadas.map(r => `R${r}`)], datasets: cD }, options: opt });
            }

            document.getElementById('playerSelect').addEventListener('change', (e) => {
                const body = document.querySelector('#dataTable tbody');
                body.innerHTML = '';
                rodadas.slice(-5).forEach((r, i) => { // Mostra apenas as últimas 5 no resumo por padrão
                    const val = data[e.target.value][data[e.target.value].length - (rodadas.length - i)];
                    body.insertAdjacentHTML('beforeend', `<tr><td>Rodada ${r}</td><td style="font-weight:700">${(val || 0).toFixed(2)}</td></tr>`);
                });
            });

            rodadaSelect.addEventListener('change', updateRodadaCharts);
            mesSelect.addEventListener('change', updateClassificacaoMensal);
            rodadasMensaisSelect.addEventListener('change', updateClassificacaoMensal);

            document.getElementById('playerSelect').dispatchEvent(new Event('change'));
            updateRodadaCharts(); updateVitoriasLanternas(); updateClassificacaoMensal(); createCumulative();
        }

        document.addEventListener('DOMContentLoaded', iniciarAplicacao);
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('Service Worker registrado!', reg))
            .catch(err => console.log('Erro ao registrar Service Worker', err));
        });
      }
    </script>
    
</body>
</html>
